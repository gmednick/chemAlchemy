---
title: Hello Tidyverse and Tidymodels
author: Gabe Mednick
date: '2020-09-03'
slug: hello-tidyverse
categories: []
tags: []
subtitle: 'Work in progress'
summary: 'Data wrangling and visualization: insights into data analysis with the tidyverse'
authors: []
lastmod: '2020-10-20'
featured: no
disable_jquery: no
image:
  caption: '[Photo by Jesse Gardner on Unsplash](https://unsplash.com/photos/JYU14tnbfOA)'
  focal_point: ''
  preview_only: no
projects: []
---
# Intro
This data comes from the R4DS TidyTuesday project. There are five related datasets but we will only look at `key_crop_yields` dataset in this exploration. The data contains crop yield (tonnes per hectare) by country and year. Let's get started by loading the packages that we will need for this analysis.

```{r, out.width="100%", include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dpi = 300, cache.lazy = FALSE,
                      tidy = "styler", fig.width = 10, fig.height = 6)
options(cli.width = 70, width = 70)

library(tidyverse)
library(tidymodels)
library(scales)
theme_set(theme_light())
```

Next up, let's download the data from the R4DS Github account and take a look at it. There is the wonderful package, tidytuesdayR by Ellis Hughes, that allows one to load and explore the TidyTuesday data in the Rstudio viewer. We will use the readr package from the tidyverse using `read_csv` to import our data as a modern data frame or tibble.
```{r}

# Load the data with a readr function
crop_yields <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/key_crop_yields.csv")

land_use <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/land_use_vs_yield_change_in_cereal_production.csv") %>% janitor::clean_names()
# The skim function provides a great way to get an initial summary. I typically use View() as well to view the dataset in Rstudio
skimr::skim(crop_yields)

# Here are a few other options for getting to know our data
# glimpse(crop_yields) 
# summary(crop_yields)
# View(crop_yields)
```
# Data cleaning and reshaping
Let's start with a little data cleaning! Using `skim` from `skimr` provides a convenient summary. We can see that there are plenty of NAs that we will most likely need to remove. We can also standardize our feature names with the janitor package. Lastly, we should consider the shape of our data and make sure that it's in a tidy format where each column is a feature and each row a sample.This long or tidy format is a prerequisite for fluent analysis with the tidyverse and tidymodels frameworks. In our data example, the various crops on samples, that can be categorized as the feature `crops`. The function `pivot_longer` is fantastic function from the tidyr package that allows us to reshape our data and preparing it for  This will benefit our downstream analysis, including EDA (exploratory data analysis) and modeling (machine learning). 
```{r}
crop_yields %>% count(Year)
# Use janitor package to clean column names and pivot_longer from tidyr to tidy the data.
crop_yield_tidy <- crop_yields %>% 
  janitor::clean_names() %>% 
  rename_all(str_remove, "_tonnes.*") %>% 
  rename(country = entity) %>% 
  pivot_longer(wheat:bananas, names_to = 'crop', values_to = 'yield_hectare') %>% 
  drop_na(yield_hectare)

kable(head(crop_yield_tidy, n = 10))

```


# Visual analysis
Now that we have the data in tidy format, let's see what we can learn from it. We want to look at crop production by country but there are too many countries to look at in a single plot. `slice_sample()` can be used to randomly select a subset of the total countries. We will use the results to visualize a subset of the countries with the idea that this will help us get a feel for relationships in the data. For more refined control of the country selection, we could incorporate the code into a Shiny dashboard with user conntrolled selection inputs. 

```{r}
# Randomly select 4 country codes
# set.seed(1014)
country_random <- crop_yield_tidy %>% 
  select(country) %>% 
  distinct() %>% 
  slice_sample(n = 9) %>% 
  pull()

# another option would be to set the code equal to a set selection of countries: E.g., countries <- c('GUM',	'IND',	'YEM',	'NAM',	'URY', 'USA')

# Plot crop yield per hectare.
library(tidytext)

column_plot <- crop_yield_tidy %>% 
  filter(year >= 2000,
         country == country_random) %>% 
  mutate(crop = reorder_within(crop, yield_hectare, country)) %>%
  ggplot(aes(yield_hectare, crop, fill = crop)) +
  geom_col()  +
  facet_wrap(~country, scales = 'free_y') +
  theme(legend.position =  'none') +
  scale_y_reordered() +
  labs(
    title = 'Crop Yield',
    y = 'Crop',
    x = 'yield per hectare'
  )
column_plot
```
**Figure 1.** This column plot shows the crop on the y-axis, yield on the x-axis and is faceted by country.

```{r}
# Plot crop yield per hectare per year.
line_plot <- crop_yield_tidy %>% 
  filter(year >= 2000,
         country == country_random) %>% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %>% 
  ggplot(aes(year, yield_hectare, color = crop)) +
  geom_line() +
  facet_wrap(~country, scales = 'free_y') +
  labs(
     y = 'yield per hectare',
    title = 'Crop Yield'
  )
line_plot
```


```{r}
# Plot crop yield per hectare per year.
box_plot <- crop_yield_tidy %>% 
  filter(year >= 2000,
         country == country_random) %>% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %>% 
  ggplot(aes(yield_hectare, crop, color = crop)) +
  geom_boxplot() +
  theme(legend.position =  'none') +
  facet_wrap(~country, scales = 'free') +
  labs(
    x = 'Yield',
    title = 'Crop Yield',
    y = ''
  )
box_plot

```

