---
title: Hello Tidyverse and Tidymodels
author: Gabe Mednick
date: '2020-09-03'
slug: hello-tidyverse
categories: []
tags: []
subtitle: ''
summary: 'Data wrangling and visualization: insights into data analysis with the tidyverse'
authors: []
lastmod: '2020-09-03T22:12:24-07:00'
featured: no
disable_jquery: no
image:
  caption: '[Photo by Jesse Gardner on Unsplash](https://unsplash.com/photos/JYU14tnbfOA)'
  focal_point: ''
  preview_only: no
projects: []
---
# Intro
This dataset was made available by the TidyTuesday project on the first of September, 2020. There are five related datasets in total but we will only look at `key_crop_yields` in this exploration. The data contains crop yield by country and year. Let's get started by loading the packages that we will need for this analysis.

```{r, out.width="100%", include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dpi = 300, cache.lazy = FALSE,
                      tidy = "styler", fig.width = 8, fig.height = 5)
options(cli.width = 70, width = 70)

library(tidyverse)
library(tidymodels)
library(shiny)
library(gt)
library(scales)
theme_set(theme_light())
```

Next up, let's download the data from the R4DS Github account and take a look at it. There is the wonderful package, tidytuesdayR by Ellis Hughes, for loading and exploring the TidyTuesday data but today I will use the readr package from the tidyverse since we are only going to look at the crop yields dataset. `read_csv` will load the data as modern data frame called a tibble.
```{r}

# Load the data with a readr function
crop_yields <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/key_crop_yields.csv")

# The skim function provides a great way to get an initial summary. I typically use View() as well to view the dataset in Rstudio
# skimr::skim(crop_yields)
glimpse(crop_yields)
summary(crop_yields)

```
# Data cleaning and reshaping
It's time for a little data cleaning! For starters, we can see from the skimr summary that there are a bunch of NAs that we need to decide what to do with. We can also standarize our feature names with the janitor package. We should also consider whether our data is in a tidy format where each column is a feature and each row a sample since this is fundamental necessity for working with data in the tidyverse and tidymodels frameworks. In our data example, the various crops on samples, that can be categorized as the feature `crops`. The function `pivot_longer` is fantastic function from the tidyr package that allows us to reshape our data and preparing it for  This will benefit our downstream analysis, including EDA (exploratory data analysis) and modeling (machine learning). 
```{r}
crop_yields %>% count(Year)
# Use janitor package to clean column names and pivot_longer from tidyr to tidy the data.
crop_yield_tidy <- crop_yields %>% 
  janitor::clean_names() %>% 
  rename_all(str_remove, "_tonnes.*") %>% 
  rename(country = entity) %>% 
  pivot_longer(wheat:bananas, names_to = 'crop', values_to = 'yield_hectare') %>% 
  drop_na(yield_hectare)

kable(head(crop_yield_tidy, n = 10))

```
# Visual analysis
Now that we have the data in tidy format, let's see what we can learn from it. We want to look at crop production by country but there are too many countries to look at all of them at once. `slice_sample()` can be used to randomly select a subset of the total countries. A seed can be set if you want `slice_sample` to return the same 8 countries each time. We will use the results to visualize a subset of the countries with the idea that this will help us understand our data better and generate questions that can guide our predictive modeling. 

```{r}
# Randomly select 4 country codes
# set.seed(1014)
country_random <- crop_yield_tidy %>% 
  select(country) %>% 
  distinct() %>% 
  slice_sample(n = 9) %>% 
  pull()

# another option would be to set the code equal to a set selection of countries: E.g., countries <- c('GUM',	'IND',	'YEM',	'NAM',	'URY', 'USA')

# Plot crop yield per hectare.
library(tidytext)
column_plot <- crop_yield_tidy %>% 
  filter(year >= 2000,
         country == country_random) %>% 
  mutate(crop = reorder_within(crop, yield_hectare, country)) %>%
  ggplot(aes(yield_hectare, crop, fill = crop)) +
  geom_col()  +
  facet_wrap(~country, scales = 'free') +
  theme(legend.position =  'none') +
  scale_y_reordered() +
  labs(
    title = 'Crop Yield',
    y = 'Crop',
    x = 'yield per hectare'
  )
column_plot
```


```{r}
# Plot crop yield per hectare per year.
line_plot <- crop_yield_tidy %>% 
  filter(year >= 2000,
         country == country_random) %>% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %>% 
  ggplot(aes(year, yield_hectare, color = crop)) +
  geom_line() +
  facet_wrap(~country, scales = 'free_y') +
  labs(
     y = 'yield per hectare',
    title = 'Crop Yield'
  )
line_plot
```


```{r}
# Plot crop yield per hectare per year.
box_plot <- crop_yield_tidy %>% 
  filter(year >= 2000,
         country == country_random) %>% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %>% 
  ggplot(aes(yield_hectare, crop, color = crop)) +
  geom_boxplot() +
  theme(legend.position =  'none') +
  facet_wrap(~country, scales = 'free') +
  labs(
    x = 'Yield',
    title = 'Crop Yield',
    y = ''
  )
box_plot

```

