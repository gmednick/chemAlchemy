---
title: Hello Tidyverse and Tidymodels
author: Gabe Mednick
date: '2020-09-03'
slug: hello-tidyverse
categories: []
tags: []
subtitle: 'Work in progress'
summary: 'Data wrangling and visualization: insights into data analysis with the tidyverse'
authors: []
lastmod: '2020-10-20'
featured: no
disable_jquery: no
image:
  caption: '[Photo by Jesse Gardner on Unsplash](https://unsplash.com/photos/JYU14tnbfOA)'
  focal_point: ''
  preview_only: no
projects: []
---



<div id="intro" class="section level1">
<h1>Intro</h1>
<p>This post uses data from the <i class='fab fa-r-project'  style='color: #367588'></i> for Data Science online learning community. Each Tuesday, a dataset is posted and people share their analyses and visualizations on Twitter with the hashtag, #TidyTuesday. This week’s dataset (September 1st, 2020) is from [Our World in Data] (<a href="https://ourworldindata.org/crop-yields" class="uri">https://ourworldindata.org/crop-yields</a>). There are actually five datasets but we are going to focus on global crop yields.</p>
</div>
<div id="download-and-view-the-data" class="section level1">
<h1>Download and view the data</h1>
<p>Let’s start by downloading the data from the <a href="https://github.com/rfordatascience/tidytuesday">R4DS Github</a> account and take a look at it. the tidytuesdayR package (by Ellis Hughes, co-host of the screencast ‘TidyX’) is a handy package for checking out available datasets, exploring the data dictionary in the Rstudio viewer and loading the desired data (and more). Although simple to use, I’m going to stick with the <code>readr::read_csv()</code> from the tidyverse to import the data as a tibble (data frame).</p>
<pre class="r"><code># Load the data with a readr function
crop_yields &lt;- read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/key_crop_yields.csv&quot;)

land_use &lt;- read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/land_use_vs_yield_change_in_cereal_production.csv&quot;) %&gt;% janitor::clean_names()


skimr::skim(crop_yields)</code></pre>
<table>
<caption><span id="tab:unnamed-chunk-2">Table 1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">crop_yields</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">13075</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">14</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">2</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">12</td>
</tr>
<tr class="even">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Entity</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">4</td>
<td align="right">39</td>
<td align="right">0</td>
<td align="right">249</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Code</td>
<td align="right">1919</td>
<td align="right">0.85</td>
<td align="right">3</td>
<td align="right">8</td>
<td align="right">0</td>
<td align="right">214</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<colgroup>
<col width="28%" />
<col width="8%" />
<col width="11%" />
<col width="6%" />
<col width="5%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="6%" />
<col width="5%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Year</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">1990.37</td>
<td align="right">16.73</td>
<td align="right">1961.00</td>
<td align="right">1976.00</td>
<td align="right">1991.00</td>
<td align="right">2005.00</td>
<td align="right">2018.00</td>
<td align="left">▇▆▇▇▇</td>
</tr>
<tr class="even">
<td align="left">Wheat (tonnes per hectare)</td>
<td align="right">4974</td>
<td align="right">0.62</td>
<td align="right">2.43</td>
<td align="right">1.69</td>
<td align="right">0.00</td>
<td align="right">1.23</td>
<td align="right">1.99</td>
<td align="right">3.12</td>
<td align="right">10.67</td>
<td align="left">▇▅▂▁▁</td>
</tr>
<tr class="odd">
<td align="left">Rice (tonnes per hectare)</td>
<td align="right">4604</td>
<td align="right">0.65</td>
<td align="right">3.16</td>
<td align="right">1.85</td>
<td align="right">0.20</td>
<td align="right">1.77</td>
<td align="right">2.74</td>
<td align="right">4.16</td>
<td align="right">10.68</td>
<td align="left">▇▇▃▁▁</td>
</tr>
<tr class="even">
<td align="left">Maize (tonnes per hectare)</td>
<td align="right">2301</td>
<td align="right">0.82</td>
<td align="right">3.02</td>
<td align="right">3.13</td>
<td align="right">0.03</td>
<td align="right">1.14</td>
<td align="right">1.83</td>
<td align="right">3.92</td>
<td align="right">36.76</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">Soybeans (tonnes per hectare)</td>
<td align="right">7114</td>
<td align="right">0.46</td>
<td align="right">1.45</td>
<td align="right">0.75</td>
<td align="right">0.00</td>
<td align="right">0.86</td>
<td align="right">1.33</td>
<td align="right">1.90</td>
<td align="right">5.95</td>
<td align="left">▇▇▂▁▁</td>
</tr>
<tr class="even">
<td align="left">Potatoes (tonnes per hectare)</td>
<td align="right">3059</td>
<td align="right">0.77</td>
<td align="right">15.40</td>
<td align="right">9.29</td>
<td align="right">0.84</td>
<td align="right">8.64</td>
<td align="right">13.41</td>
<td align="right">20.05</td>
<td align="right">75.30</td>
<td align="left">▇▅▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">Beans (tonnes per hectare)</td>
<td align="right">5066</td>
<td align="right">0.61</td>
<td align="right">1.09</td>
<td align="right">0.82</td>
<td align="right">0.03</td>
<td align="right">0.59</td>
<td align="right">0.83</td>
<td align="right">1.35</td>
<td align="right">9.18</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">Peas (tonnes per hectare)</td>
<td align="right">6840</td>
<td align="right">0.48</td>
<td align="right">1.48</td>
<td align="right">1.01</td>
<td align="right">0.04</td>
<td align="right">0.72</td>
<td align="right">1.15</td>
<td align="right">1.99</td>
<td align="right">7.16</td>
<td align="left">▇▃▁▁▁</td>
</tr>
<tr class="odd">
<td align="left">Cassava (tonnes per hectare)</td>
<td align="right">5887</td>
<td align="right">0.55</td>
<td align="right">9.34</td>
<td align="right">5.11</td>
<td align="right">1.00</td>
<td align="right">5.55</td>
<td align="right">8.67</td>
<td align="right">11.99</td>
<td align="right">38.58</td>
<td align="left">▇▇▁▁▁</td>
</tr>
<tr class="even">
<td align="left">Barley (tonnes per hectare)</td>
<td align="right">6342</td>
<td align="right">0.51</td>
<td align="right">2.23</td>
<td align="right">1.50</td>
<td align="right">0.09</td>
<td align="right">1.05</td>
<td align="right">1.88</td>
<td align="right">3.02</td>
<td align="right">9.15</td>
<td align="left">▇▆▂▁▁</td>
</tr>
<tr class="odd">
<td align="left">Cocoa beans (tonnes per hectare)</td>
<td align="right">8466</td>
<td align="right">0.35</td>
<td align="right">0.39</td>
<td align="right">0.28</td>
<td align="right">0.00</td>
<td align="right">0.24</td>
<td align="right">0.36</td>
<td align="right">0.49</td>
<td align="right">3.43</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">Bananas (tonnes per hectare)</td>
<td align="right">4166</td>
<td align="right">0.68</td>
<td align="right">15.20</td>
<td align="right">12.08</td>
<td align="right">0.66</td>
<td align="right">5.94</td>
<td align="right">11.78</td>
<td align="right">20.79</td>
<td align="right">77.59</td>
<td align="left">▇▃▁▁▁</td>
</tr>
</tbody>
</table>
<pre class="r"><code># Here are a few other options for getting to know the data
# glimpse(crop_yields) 
# summary(crop_yields)
# View(crop_yields)</code></pre>
</div>
<div id="tidy-data-cleaning-and-reshaping" class="section level1">
<h1>Tidy data: cleaning and reshaping</h1>
<p>Let’s start with a little data cleaning! <code>skim()</code> from <code>skimr</code> provides a convenient summary. By looking at the data we can see that there are missing values that need to be removed or imputed but other than that, the data is clean. One thing we should consider is whether the data is in a tidy format where each column is a feature and each row a sample. This long format facilitates fluent analysis with the tidyverse. The function <code>pivot_longer()</code> from the tidyr package allows us to reshape the data and prepare it for exploratory data analysis (EDA).</p>
<pre class="r"><code>crop_yields %&gt;% count(Year)</code></pre>
<pre><code>## # A tibble: 58 x 2
##     Year     n
##    &lt;dbl&gt; &lt;int&gt;
##  1  1961   209
##  2  1962   209
##  3  1963   209
##  4  1964   209
##  5  1965   209
##  6  1966   211
##  7  1967   211
##  8  1968   213
##  9  1969   213
## 10  1970   213
## # … with 48 more rows</code></pre>
<pre class="r"><code># Use janitor package to clean column names and pivot_longer from tidyr to tidy the data.
crop_yield_tidy &lt;- crop_yields %&gt;% 
  janitor::clean_names() %&gt;% 
  rename_all(str_remove, &quot;_tonnes.*&quot;) %&gt;% 
  rename(country = entity) %&gt;% 
  pivot_longer(wheat:bananas, names_to = &#39;crop&#39;, values_to = &#39;yield_hectare&#39;) %&gt;% 
  drop_na(yield_hectare)

kable(head(crop_yield_tidy, n = 10))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="left">code</th>
<th align="right">year</th>
<th align="left">crop</th>
<th align="right">yield_hectare</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">wheat</td>
<td align="right">1.0220</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">rice</td>
<td align="right">1.5190</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">maize</td>
<td align="right">1.4000</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">potatoes</td>
<td align="right">8.6667</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">barley</td>
<td align="right">1.0800</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">wheat</td>
<td align="right">0.9735</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">rice</td>
<td align="right">1.5190</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">maize</td>
<td align="right">1.4000</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">potatoes</td>
<td align="right">7.6667</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">barley</td>
<td align="right">1.0800</td>
</tr>
</tbody>
</table>
</div>
<div id="what-can-we-learn-from-this-dataset" class="section level1">
<h1>What can we learn from this dataset?</h1>
<p>A great place to start an analysis is by grouping and counting features using the <code>count()</code> function. For this project, I have not set out with a specific analysis or machine learning predictive task in mind. By spending time with data, counting and plotting it, we can get a feel for relationships and hopefully generate some insight about what types of questions can we answer. For instance, with this data</p>
<pre class="r"><code>crop_yield_tidy %&gt;%
  count(year, country, sort = TRUE)</code></pre>
<pre><code>## # A tibble: 13,075 x 3
##     year country                              n
##    &lt;dbl&gt; &lt;chr&gt;                            &lt;int&gt;
##  1  1961 Africa                              11
##  2  1961 Americas                            11
##  3  1961 Asia                                11
##  4  1961 Central America                     11
##  5  1961 Colombia                            11
##  6  1961 Democratic Republic of Congo        11
##  7  1961 Eastern Africa                      11
##  8  1961 Ecuador                             11
##  9  1961 Land Locked Developing Countries    11
## 10  1961 Least Developed Countries           11
## # … with 13,065 more rows</code></pre>
<pre class="r"><code>tidy_select &lt;- crop_yield_tidy %&gt;%
  count(country, sort = TRUE) %&gt;%
  filter(n &gt;=500)

crop_yield_tidy %&gt;%
  summarize(max(year)- min(year)) #57 years of recorded data</code></pre>
<pre><code>## # A tibble: 1 x 1
##   `max(year) - min(year)`
##                     &lt;dbl&gt;
## 1                      57</code></pre>
<pre class="r"><code>crop_yield_tidy %&gt;%
  count(year, crop, sort = T)</code></pre>
<pre><code>## # A tibble: 638 x 3
##     year crop      n
##    &lt;dbl&gt; &lt;chr&gt; &lt;int&gt;
##  1  2012 maize   201
##  2  2013 maize   201
##  3  2014 maize   201
##  4  2015 maize   201
##  5  2016 maize   201
##  6  2017 maize   201
##  7  2018 maize   201
##  8  2010 maize   200
##  9  2011 maize   200
## 10  2006 maize   199
## # … with 628 more rows</code></pre>
<pre class="r"><code>crop_yield_tidy %&gt;%
  filter(country == &#39;United States&#39;) %&gt;%
  count(crop)</code></pre>
<pre><code>## # A tibble: 9 x 2
##   crop         n
##   &lt;chr&gt;    &lt;int&gt;
## 1 bananas     58
## 2 barley      58
## 3 beans       58
## 4 maize       58
## 5 peas        58
## 6 potatoes    58
## 7 rice        58
## 8 soybeans    58
## 9 wheat       58</code></pre>
</div>
<div id="visual-analysis" class="section level1">
<h1>Visual analysis</h1>
<p>Now that we have the data in tidy format, let’s see what we can learn from visual analysis. We want to look at crop production by country but we can’t plot every country. For more refined control of country selection, we could incorporate the code into a Shiny dashboard.</p>
<p>We will use <code>slice_sample()</code> can be used to randomly select a subset of the total countries. To get a feel for the data, we will select nine countries. It’s worth noting that the randomly selected countries will not always have all crops.</p>
<pre class="r"><code># Randomly select 9 country names
# set.seed(1014) if you want to select the same 9 countries each time
crops &lt;- crop_yield_tidy %&gt;% distinct(crop) %&gt;%  pull()
country_random &lt;- crop_yield_tidy %&gt;% 
  # filter(crop %in% crops) %&gt;% 
  select(country) %&gt;% 
  distinct() %&gt;% 
  slice_sample(n = 9) %&gt;% 
  pull()

# another option would be to set the code equal to a set selection of countries: E.g., countries &lt;- c(&#39;GUM&#39;,    &#39;IND&#39;,  &#39;YEM&#39;,  &#39;NAM&#39;,  &#39;URY&#39;, &#39;USA&#39;)

# Plot crop yield per hectare.
library(tidytext)
# plot of USA data only
usa_col_plot &lt;- crop_yield_tidy %&gt;% 
  filter(country == &#39;United States&#39;) %&gt;% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %&gt;%
  ggplot(aes(yield_hectare, crop, fill = crop)) +
  geom_col()  +
  facet_wrap(~country, scales = &#39;free_y&#39;) +
  theme(legend.position =  &#39;none&#39;) +
  labs(
    title = &#39;Crop Yield USA&#39;,
    y = &#39;Crop&#39;,
    x = &#39;tonnes per hectare&#39;
  )
usa_col_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-5-1.png" width="3000" /></p>
<pre class="r"><code># this is what I started with.
# crop_yield_tidy %&gt;% 
#   filter(country == country_random) %&gt;% 
#   mutate(crop = fct_reorder(crop, yield_hectare)) %&gt;%
#   ggplot(aes(yield_hectare, crop, fill = crop)) +
#   geom_col()  +
#   facet_wrap(~country, scales = &#39;free_y&#39;)

column_plot &lt;- crop_yield_tidy %&gt;% 
  filter(country == country_random,
         crop == c(&#39;maize&#39;, &#39;potatoes&#39;, &#39;wheat&#39;, &#39;bananas&#39;)) %&gt;% 
  mutate(crop = reorder_within(crop, yield_hectare, country)) %&gt;%
  ggplot(aes(yield_hectare, crop, fill = crop)) +
  geom_col()  +
  scale_y_reordered() +
  facet_wrap(~country, scales = &#39;free&#39;) +
  theme(legend.position =  &#39;none&#39;) +
  labs(
    title = &#39;Crop Yield&#39;,
    y = &#39;Crop&#39;,
    x = &#39;yield per hectare&#39;
  )
column_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-5-2.png" width="3000" /></p>
<pre class="r"><code># Plot crop yield per hectare per year.
line_plot &lt;- crop_yield_tidy %&gt;% 
  filter(year &gt;= 2000,
         country == country_random) %&gt;% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %&gt;% 
  ggplot(aes(year, yield_hectare, color = crop)) +
  geom_line() +
  facet_wrap(~country, scales = &#39;free_y&#39;) +
  labs(
     y = &#39;yield per hectare&#39;,
    title = &#39;Crop Yield&#39;
  )
line_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-6-1.png" width="3000" /></p>
<pre class="r"><code># Plot crop yield per hectare per year.
box_plot &lt;- crop_yield_tidy %&gt;% 
  filter(year &gt;= 2000,
         country == country_random) %&gt;% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %&gt;% 
  ggplot(aes(yield_hectare, crop, color = crop)) +
  geom_boxplot() +
  theme(legend.position =  &#39;none&#39;) +
  facet_wrap(~country, scales = &#39;free&#39;) +
  labs(
    x = &#39;Yield&#39;,
    title = &#39;Crop Yield&#39;,
    y = &#39;&#39;
  )
box_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-7-1.png" width="3000" /></p>
</div>
