---
title: Hello Tidyverse and Tidymodels
author: Gabe Mednick
date: '2020-09-03'
slug: hello-tidyverse
categories: []
tags: []
subtitle: ''
summary: 'Data wrangling and visualization: insights into data analysis with the tidyverse'
authors: []
lastmod: '2020-09-03T22:12:24-07:00'
featured: no
disable_jquery: no
image:
  caption: '[Photo by Jesse Gardner on Unsplash](https://unsplash.com/photos/JYU14tnbfOA)'
  focal_point: ''
  preview_only: no
projects: []
---



<div id="intro" class="section level1">
<h1>Intro</h1>
<p>This dataset was made available by the TidyTuesday project on the first of September, 2020. There are five related datasets in total but we will only look at <code>key_crop_yields</code> in this exploration. The data contains crop yield by country and year. Let’s get started by loading the packages that we will need for this analysis.</p>
<p>Next up, let’s download the data from the R4DS Github account and take a look at it. There is the wonderful package, tidytuesdayR by Ellis Hughes, for loading and exploring the TidyTuesday data but today I will use the readr package from the tidyverse since we are only going to look at the crop yields dataset. <code>read_csv</code> will load the data as modern data frame called a tibble.</p>
<pre class="r"><code># Load the data with a readr function
crop_yields &lt;- read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/key_crop_yields.csv&quot;)

# The skim function provides a great way to get an initial summary. I typically use View() as well to view the dataset in Rstudio
# skimr::skim(crop_yields)
glimpse(crop_yields)</code></pre>
<pre><code>## Rows: 13,075
## Columns: 14
## $ Entity                             &lt;chr&gt; &quot;Afghanistan&quot;, &quot;Afghanis…
## $ Code                               &lt;chr&gt; &quot;AFG&quot;, &quot;AFG&quot;, &quot;AFG&quot;, &quot;AF…
## $ Year                               &lt;dbl&gt; 1961, 1962, 1963, 1964, …
## $ `Wheat (tonnes per hectare)`       &lt;dbl&gt; 1.0220, 0.9735, 0.8317, …
## $ `Rice (tonnes per hectare)`        &lt;dbl&gt; 1.5190, 1.5190, 1.5190, …
## $ `Maize (tonnes per hectare)`       &lt;dbl&gt; 1.4000, 1.4000, 1.4260, …
## $ `Soybeans (tonnes per hectare)`    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, …
## $ `Potatoes (tonnes per hectare)`    &lt;dbl&gt; 8.6667, 7.6667, 8.1333, …
## $ `Beans (tonnes per hectare)`       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, …
## $ `Peas (tonnes per hectare)`        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, …
## $ `Cassava (tonnes per hectare)`     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, …
## $ `Barley (tonnes per hectare)`      &lt;dbl&gt; 1.0800, 1.0800, 1.0800, …
## $ `Cocoa beans (tonnes per hectare)` &lt;dbl&gt; NA, NA, NA, NA, NA, NA, …
## $ `Bananas (tonnes per hectare)`     &lt;dbl&gt; NA, NA, NA, NA, NA, NA, …</code></pre>
<pre class="r"><code>summary(crop_yields)</code></pre>
<pre><code>##     Entity              Code                Year     
##  Length:13075       Length:13075       Min.   :1961  
##  Class :character   Class :character   1st Qu.:1976  
##  Mode  :character   Mode  :character   Median :1991  
##                                        Mean   :1990  
##                                        3rd Qu.:2005  
##                                        Max.   :2018  
##                                                      
##  Wheat (tonnes per hectare) Rice (tonnes per hectare)
##  Min.   : 0.000             Min.   : 0.203           
##  1st Qu.: 1.228             1st Qu.: 1.767           
##  Median : 1.990             Median : 2.744           
##  Mean   : 2.435             Mean   : 3.162           
##  3rd Qu.: 3.124             3rd Qu.: 4.157           
##  Max.   :10.668             Max.   :10.683           
##  NA&#39;s   :4974               NA&#39;s   :4604             
##  Maize (tonnes per hectare) Soybeans (tonnes per hectare)
##  Min.   : 0.0343            Min.   :0.005                
##  1st Qu.: 1.1423            1st Qu.:0.860                
##  Median : 1.8251            Median :1.334                
##  Mean   : 3.0245            Mean   :1.449                
##  3rd Qu.: 3.9220            3rd Qu.:1.905                
##  Max.   :36.7619            Max.   :5.947                
##  NA&#39;s   :2301               NA&#39;s   :7114                 
##  Potatoes (tonnes per hectare) Beans (tonnes per hectare)
##  Min.   : 0.8406               Min.   :0.027             
##  1st Qu.: 8.6383               1st Qu.:0.586             
##  Median :13.4144               Median :0.832             
##  Mean   :15.3977               Mean   :1.086             
##  3rd Qu.:20.0521               3rd Qu.:1.346             
##  Max.   :75.2987               Max.   :9.178             
##  NA&#39;s   :3059                  NA&#39;s   :5066              
##  Peas (tonnes per hectare) Cassava (tonnes per hectare)
##  Min.   :0.044             Min.   : 1.000              
##  1st Qu.:0.723             1st Qu.: 5.553              
##  Median :1.146             Median : 8.667              
##  Mean   :1.480             Mean   : 9.345              
##  3rd Qu.:1.992             3rd Qu.:11.989              
##  Max.   :7.164             Max.   :38.582              
##  NA&#39;s   :6840              NA&#39;s   :5887                
##  Barley (tonnes per hectare) Cocoa beans (tonnes per hectare)
##  Min.   :0.094               Min.   :0.000                   
##  1st Qu.:1.047               1st Qu.:0.244                   
##  Median :1.877               Median :0.363                   
##  Mean   :2.232               Mean   :0.395                   
##  3rd Qu.:3.024               3rd Qu.:0.487                   
##  Max.   :9.146               Max.   :3.429                   
##  NA&#39;s   :6342                NA&#39;s   :8466                    
##  Bananas (tonnes per hectare)
##  Min.   : 0.664              
##  1st Qu.: 5.944              
##  Median :11.775              
##  Mean   :15.201              
##  3rd Qu.:20.791              
##  Max.   :77.592              
##  NA&#39;s   :4166</code></pre>
</div>
<div id="data-cleaning-and-reshaping" class="section level1">
<h1>Data cleaning and reshaping</h1>
<p>It’s time for a little data cleaning! For starters, we can see from the skimr summary that there are a bunch of NAs that we need to decide what to do with. We can also standarize our feature names with the janitor package. We should also consider whether our data is in a tidy format where each column is a feature and each row a sample since this is fundamental necessity for working with data in the tidyverse and tidymodels frameworks. In our data example, the various crops on samples, that can be categorized as the feature <code>crops</code>. The function <code>pivot_longer</code> is fantastic function from the tidyr package that allows us to reshape our data and preparing it for This will benefit our downstream analysis, including EDA (exploratory data analysis) and modeling (machine learning).</p>
<pre class="r"><code>crop_yields %&gt;% count(Year)</code></pre>
<pre><code>## # A tibble: 58 x 2
##     Year     n
##    &lt;dbl&gt; &lt;int&gt;
##  1  1961   209
##  2  1962   209
##  3  1963   209
##  4  1964   209
##  5  1965   209
##  6  1966   211
##  7  1967   211
##  8  1968   213
##  9  1969   213
## 10  1970   213
## # … with 48 more rows</code></pre>
<pre class="r"><code># Use janitor package to clean column names and pivot_longer from tidyr to tidy the data.
crop_yield_tidy &lt;- crop_yields %&gt;% 
  janitor::clean_names() %&gt;% 
  rename_all(str_remove, &quot;_tonnes.*&quot;) %&gt;% 
  rename(country = entity) %&gt;% 
  pivot_longer(wheat:bananas, names_to = &#39;crop&#39;, values_to = &#39;yield_hectare&#39;) %&gt;% 
  drop_na(yield_hectare)

kable(head(crop_yield_tidy, n = 10))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="left">code</th>
<th align="right">year</th>
<th align="left">crop</th>
<th align="right">yield_hectare</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">wheat</td>
<td align="right">1.0220</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">rice</td>
<td align="right">1.5190</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">maize</td>
<td align="right">1.4000</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">potatoes</td>
<td align="right">8.6667</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1961</td>
<td align="left">barley</td>
<td align="right">1.0800</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">wheat</td>
<td align="right">0.9735</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">rice</td>
<td align="right">1.5190</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">maize</td>
<td align="right">1.4000</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">potatoes</td>
<td align="right">7.6667</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="left">AFG</td>
<td align="right">1962</td>
<td align="left">barley</td>
<td align="right">1.0800</td>
</tr>
</tbody>
</table>
</div>
<div id="visual-analysis" class="section level1">
<h1>Visual analysis</h1>
<p>Now that we have the data in tidy format, let’s see what we can learn from it. We want to look at crop production by country but there are too many countries to look at all of them at once. <code>slice_sample()</code> can be used to randomly select a subset of the total countries. A seed can be set if you want <code>slice_sample</code> to return the same 8 countries each time. We will use the results to visualize a subset of the countries with the idea that this will help us understand our data better and generate questions that can guide our predictive modeling.</p>
<pre class="r"><code># Randomly select 4 country codes
# set.seed(1014)
country_random &lt;- crop_yield_tidy %&gt;% 
  select(country) %&gt;% 
  distinct() %&gt;% 
  slice_sample(n = 9) %&gt;% 
  pull()

# another option would be to set the code equal to a set selection of countries: E.g., countries &lt;- c(&#39;GUM&#39;,    &#39;IND&#39;,  &#39;YEM&#39;,  &#39;NAM&#39;,  &#39;URY&#39;, &#39;USA&#39;)

# Plot crop yield per hectare.
library(tidytext)
column_plot &lt;- crop_yield_tidy %&gt;% 
  filter(year &gt;= 2000,
         country == country_random) %&gt;% 
  mutate(crop = reorder_within(crop, yield_hectare, country)) %&gt;%
  ggplot(aes(yield_hectare, crop, fill = crop)) +
  geom_col()  +
  facet_wrap(~country, scales = &#39;free&#39;) +
  theme(legend.position =  &#39;none&#39;) +
  scale_y_reordered() +
  labs(
    title = &#39;Crop Yield&#39;,
    y = &#39;Crop&#39;,
    x = &#39;yield per hectare&#39;
  )
column_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-4-1.png" width="2400" /></p>
<pre class="r"><code># Plot crop yield per hectare per year.
line_plot &lt;- crop_yield_tidy %&gt;% 
  filter(year &gt;= 2000,
         country == country_random) %&gt;% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %&gt;% 
  ggplot(aes(year, yield_hectare, color = crop)) +
  geom_line() +
  facet_wrap(~country, scales = &#39;free_y&#39;) +
  labs(
     y = &#39;yield per hectare&#39;,
    title = &#39;Crop Yield&#39;
  )
line_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-5-1.png" width="2400" /></p>
<pre class="r"><code># Plot crop yield per hectare per year.
box_plot &lt;- crop_yield_tidy %&gt;% 
  filter(year &gt;= 2000,
         country == country_random) %&gt;% 
  mutate(crop = fct_reorder(crop, yield_hectare)) %&gt;% 
  ggplot(aes(yield_hectare, crop, color = crop)) +
  geom_boxplot() +
  theme(legend.position =  &#39;none&#39;) +
  facet_wrap(~country, scales = &#39;free&#39;) +
  labs(
    x = &#39;Yield&#39;,
    title = &#39;Crop Yield&#39;,
    y = &#39;&#39;
  )
box_plot</code></pre>
<p><img src="/post/2020-09-03-hello-tidyverse/index_files/figure-html/unnamed-chunk-6-1.png" width="2400" /></p>
</div>
